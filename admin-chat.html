<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>Admin Chat ‚Äî VoltEdge</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Fraunces:opsz,wght@9..144,600;9..144,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<style>
:root {
  --navy: #0b2156;
  --navy-mid: #1a3a8f;
  --navy-light: #eef2ff;
  --accent: #4f6ef7;
  --accent-soft: rgba(79,110,247,.1);
  --surface: #ffffff;
  --body-bg: #f4f6fc;
  --border: #e4e9f4;
  --text: #0d1526;
  --text-muted: #6b7a99;
  --text-light: #a3adc2;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --shadow-sm: 0 1px 3px rgba(11,33,86,.07);
  --shadow-md: 0 4px 16px rgba(11,33,86,.09);
  --shadow-lg: 0 8px 30px rgba(11,33,86,.13);
  --radius: 14px;
  --radius-sm: 10px;
  --sidebar-w: 310px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; }
body { font-family: 'DM Sans', sans-serif; background: var(--body-bg); color: var(--text); display: flex; flex-direction: column; overflow: hidden; }
button { font-family: 'DM Sans', sans-serif; cursor: pointer; border: none; }

.app { display: flex; height: 100vh; overflow: hidden; position: relative; }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  width: var(--sidebar-w); background: var(--surface);
  display: flex; flex-direction: column;
  border-right: 1px solid var(--border); flex-shrink: 0;
  box-shadow: 2px 0 16px rgba(11,33,86,.05); z-index: 10;
  transition: transform 0.3s ease;
}

.sidebar-header {
  padding: 1rem 1.1rem .95rem;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; gap: .5rem;
}

.brand { display: flex; align-items: center; gap: .65rem; }
.brand-mark {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--navy) 0%, var(--accent) 100%);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 1rem; box-shadow: 0 3px 10px rgba(79,110,247,.35); flex-shrink: 0;
}
.brand-text .bname { font-family: 'Fraunces', serif; font-size: 1rem; font-weight: 700; color: var(--navy); line-height: 1; }
.brand-text .bname span { color: var(--accent); }
.brand-text .bsub { font-size: .62rem; color: var(--text-light); margin-top: .2rem; font-weight: 500; letter-spacing: .04em; text-transform: uppercase; }

.back-btn {
  display: flex; align-items: center; gap: .38rem;
  background: var(--body-bg); border: 1.5px solid var(--border);
  color: var(--text-muted); font-size: .71rem; font-weight: 600;
  padding: .38rem .7rem; border-radius: 8px;
  transition: all .2s; flex-shrink: 0; white-space: nowrap;
}
.back-btn:hover { background: var(--navy-light); border-color: var(--accent); color: var(--accent); }

.sidebar-search { padding: .85rem 1rem; border-bottom: 1px solid var(--border); }
.search-wrap { position: relative; }
.search-ico { position: absolute; left: .75rem; top: 50%; transform: translateY(-50%); color: var(--text-light); display: flex; pointer-events: none; }
.sidebar-search input {
  width: 100%; background: var(--body-bg); border: 1.5px solid var(--border);
  color: var(--text); padding: .55rem .85rem .55rem 2.2rem;
  border-radius: var(--radius-sm); font-family: 'DM Sans', sans-serif;
  font-size: .82rem; outline: none; transition: border-color .2s, box-shadow .2s;
}
.sidebar-search input::placeholder { color: var(--text-light); }
.sidebar-search input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); background: var(--surface); }

.sidebar-label { padding: .65rem 1.1rem .3rem; font-size: .62rem; font-weight: 700; letter-spacing: .08em; color: var(--text-light); text-transform: uppercase; }

.rooms-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
.rooms-list::-webkit-scrollbar { width: 3px; }
.rooms-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.room-item {
  display: flex; align-items: center; gap: .85rem;
  padding: .85rem 1.1rem; cursor: pointer;
  transition: background .15s; border-bottom: 1px solid rgba(228,233,244,.6); position: relative;
}
.room-item:hover { background: var(--body-bg); }
.room-item.active { background: var(--navy-light); border-left: 3px solid var(--accent); padding-left: calc(1.1rem - 3px); }
.room-avatar { width: 46px; height: 46px; border-radius: 12px; overflow: hidden; flex-shrink: 0; background: var(--body-bg); border: 1.5px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; box-shadow: var(--shadow-sm); }
.room-avatar img { width: 100%; height: 100%; object-fit: cover; }
.room-info { flex: 1; min-width: 0; }
.room-product-name { font-size: .84rem; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.room-customer { font-size: .71rem; color: var(--text-muted); margin-top: .18rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: .3rem; }
.room-time { font-size: .64rem; color: var(--text-light); flex-shrink: 0; align-self: flex-start; margin-top: .1rem; }
.unread-dot { position: absolute; right: 1rem; bottom: 1rem; width: 7px; height: 7px; border-radius: 50%; background: var(--accent); }
.empty-rooms { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 2.5rem 2rem; text-align: center; }
.er-icon { font-size: 2.5rem; margin-bottom: .8rem; opacity: .4; }
.empty-rooms p { font-size: .82rem; color: var(--text-muted); line-height: 1.6; }

/* ‚îÄ‚îÄ MOBILE OVERLAY ‚îÄ‚îÄ */
.sidebar-overlay {
  display: none;
  position: fixed; inset: 0; background: rgba(11,33,86,.4);
  z-index: 9; backdrop-filter: blur(2px);
}

/* ‚îÄ‚îÄ MOBILE TOP BAR ‚îÄ‚îÄ */
.mobile-topbar {
  display: none;
  position: fixed; top: 0; left: 0; right: 0; z-index: 20;
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: .75rem 1rem; align-items: center; gap: .75rem;
  box-shadow: var(--shadow-sm);
}
.mob-hamburger {
  width: 38px; height: 38px; border-radius: 9px;
  background: var(--body-bg); border: 1.5px solid var(--border);
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
  flex-shrink: 0;
}
.mob-hamburger span { width: 16px; height: 2px; background: var(--text); border-radius: 2px; display: block; transition: all .25s; }
.mob-brand { font-family: 'Fraunces', serif; font-size: 1.05rem; font-weight: 700; color: var(--navy); flex: 1; }
.mob-brand span { color: var(--accent); }
.mob-back-btn {
  display: flex; align-items: center; gap: .3rem;
  background: var(--body-bg); border: 1.5px solid var(--border);
  color: var(--text-muted); font-size: .7rem; font-weight: 600;
  padding: .38rem .65rem; border-radius: 8px; white-space: nowrap;
}

/* ‚îÄ‚îÄ MOBILE CHAT BACK BUTTON ‚îÄ‚îÄ */
.mob-chat-back {
  display: none;
  align-items: center; gap: .4rem;
  background: none; border: none;
  color: var(--accent); font-size: .82rem; font-weight: 600;
  padding: .5rem 0; cursor: pointer;
}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--body-bg); }
.no-room { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; gap: 1rem; }
.no-room .nr-icon { font-size: 3.5rem; opacity: .3; }
.no-room h3 { font-family: 'Fraunces', serif; font-size: 1.25rem; color: var(--text-muted); }
.no-room p { font-size: .85rem; color: var(--text-light); max-width: 260px; line-height: 1.6; }

/* Chat header */
.chat-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: .9rem 1.4rem; display: flex; align-items: center; gap: 1rem; flex-shrink: 0; box-shadow: var(--shadow-sm); }
.chat-hd-product-img { width: 50px; height: 50px; border-radius: 12px; overflow: hidden; background: var(--navy-light); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; border: 1.5px solid var(--border); box-shadow: var(--shadow-sm); }
.chat-hd-product-img img { width: 100%; height: 100%; object-fit: cover; }
.chat-hd-info { flex: 1; min-width: 0; }
.chat-hd-product-name { font-weight: 700; font-size: .95rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chat-hd-product-desc { font-size: .71rem; color: var(--text-muted); margin-top: .1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chat-hd-product-price { display: inline-flex; align-items: center; gap: .4rem; margin-top: .22rem; font-size: .82rem; font-weight: 700; color: var(--navy); }
.price-pill { background: var(--navy-light); color: var(--accent); font-size: .67rem; font-weight: 700; padding: .1rem .45rem; border-radius: 6px; }
.chat-hd-right { display: flex; align-items: center; gap: .65rem; margin-left: auto; flex-shrink: 0; }
.customer-avatar { width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg, var(--navy), var(--accent)); color: #fff; font-size: .8rem; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 8px rgba(79,110,247,.3); }
.customer-info { display: flex; flex-direction: column; align-items: flex-end; }
.customer-info-name { font-size: .83rem; font-weight: 600; color: var(--text); }
.customer-info-label { font-size: .64rem; color: var(--text-light); }

/* Status */
.chat-status-bar { display: flex; align-items: center; gap: .45rem; padding: .28rem 1.4rem; font-size: .68rem; font-weight: 600; flex-shrink: 0; border-bottom: 1px solid var(--border); letter-spacing: .02em; }
.sdot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.status-connected { background: #f0fdf7; color: #065f46; }
.status-connected .sdot { background: var(--success); }
.status-polling { background: var(--navy-light); color: var(--navy-mid); }
.status-polling .sdot { background: var(--accent); animation: blink 2s infinite; }
.status-connecting { background: #fffbeb; color: #78350f; }
.status-connecting .sdot { background: var(--warning); animation: blink 1s infinite; }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:.25} }

/* Messages */
.messages-area { flex: 1; overflow-y: auto; padding: 1.25rem 1.4rem; display: flex; flex-direction: column; gap: .65rem; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
.messages-area::-webkit-scrollbar { width: 3px; }
.messages-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.cmsg { display: flex; flex-direction: column; }
.cmsg.admin { align-items: flex-end; }
.cmsg.user { align-items: flex-start; }
.bubble { max-width: 70%; padding: .65rem 1rem; border-radius: 16px; font-size: .87rem; line-height: 1.55; word-break: break-word; }
.cmsg.admin .bubble { background: var(--navy); color: #fff; border-bottom-right-radius: 4px; box-shadow: 0 2px 10px rgba(11,33,86,.18); }
.cmsg.user .bubble { background: var(--surface); color: var(--text); border-bottom-left-radius: 4px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
.msg-meta { font-size: .62rem; color: var(--text-light); margin-top: .2rem; padding: 0 .15rem; }
.msg-sender-label { font-size: .65rem; color: var(--text-muted); margin-bottom: .12rem; font-weight: 600; }

/* ‚îÄ‚îÄ PRODUCT CARD ‚îÄ‚îÄ */
.pc-msg {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden; max-width: 270px;
  box-shadow: var(--shadow-md);
  transition: box-shadow .2s, transform .2s;
}
.pc-msg:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }

.pc-img-wrap { position: relative; width: 100%; height: 148px; overflow: hidden; background: var(--navy-light); }
.pc-img-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }
.pc-msg-ph { width: 100%; height: 148px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; }

.pc-badge {
  position: absolute; top: .6rem; left: .6rem;
  background: var(--navy); color: #fff;
  font-size: .58rem; font-weight: 700;
  padding: .18rem .55rem; border-radius: 6px;
  letter-spacing: .06em; text-transform: uppercase;
}

.pc-msg-body { padding: .9rem 1rem; }
.pc-msg-name { font-weight: 700; font-size: .9rem; color: var(--text); line-height: 1.3; }

.pc-msg-price { display: flex; align-items: baseline; gap: .4rem; margin-top: .45rem; }
.pc-price-value { font-weight: 800; font-size: 1.1rem; color: var(--navy); }
.pc-price-currency { font-size: .7rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: .04em; }

.pc-msg-desc { font-size: .75rem; color: var(--text-muted); margin-top: .35rem; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

.pc-divider { height: 1px; background: var(--border); margin: .7rem 0; }

.pc-msg-footer { display: flex; align-items: center; justify-content: space-between; }
.pc-msg-time { font-size: .62rem; color: var(--text-light); }
.pc-view-btn {
  font-size: .7rem; font-weight: 700; color: var(--accent);
  background: var(--accent-soft); border: none;
  padding: .28rem .7rem; border-radius: 7px;
  cursor: pointer; transition: background .2s;
}
.pc-view-btn:hover { background: rgba(79,110,247,.18); }

.empty-msgs { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-light); font-size: .85rem; }

.day-sep { text-align: center; font-size: .63rem; color: var(--text-light); letter-spacing: .07em; margin: .4rem 0; position: relative; text-transform: uppercase; font-weight: 600; }
.day-sep::before,.day-sep::after { content: ''; position: absolute; top: 50%; width: 38%; height: 1px; background: var(--border); }
.day-sep::before{left:0;} .day-sep::after{right:0;}

/* Reply */
.reply-area { background: var(--surface); border-top: 1px solid var(--border); padding: .9rem 1.4rem; display: flex; gap: .75rem; align-items: flex-end; flex-shrink: 0; }
.reply-textarea { flex: 1; padding: .7rem 1rem; border: 1.5px solid var(--border); border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: .87rem; outline: none; resize: none; max-height: 100px; line-height: 1.5; transition: border-color .2s, box-shadow .2s; background: var(--body-bg); color: var(--text); }
.reply-textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); background: var(--surface); }
.reply-textarea::placeholder { color: var(--text-light); }
.reply-btn { background: var(--navy); color: #fff; border: none; padding: .7rem 1.4rem; border-radius: 12px; font-size: .87rem; font-weight: 700; transition: background .2s, transform .15s, box-shadow .2s; flex-shrink: 0; box-shadow: 0 2px 8px rgba(11,33,86,.2); display: flex; align-items: center; gap: .45rem; }
.reply-btn:hover:not(:disabled) { background: var(--navy-mid); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(11,33,86,.28); }
.reply-btn:active:not(:disabled) { transform: translateY(0); }
.reply-btn:disabled { background: var(--border); color: var(--text-light); cursor: not-allowed; box-shadow: none; }

/* Loader */
.loader { display: flex; align-items: center; justify-content: center; padding: 3rem; gap: .7rem; color: var(--text-muted); font-size: .85rem; }
.spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast */
.toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: .75rem 1.2rem; font-size: .84rem; color: var(--text); box-shadow: var(--shadow-lg); z-index: 999; opacity: 0; transform: translateY(10px); transition: all .3s; pointer-events: none; max-width: 280px; }
.toast.show { opacity: 1; transform: translateY(0); }
.toast.success { border-left: 3px solid var(--success); }
.toast.error { border-left: 3px solid var(--danger); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESPONSIVE BREAKPOINTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Tablet: shrink sidebar */
@media (max-width: 900px) {
  :root { --sidebar-w: 260px; }
  .customer-info { display: none; }
  .chat-hd-product-desc { display: none; }
}

/* Mobile: slide-over sidebar, full-screen chat */
@media (max-width: 640px) {
  .mobile-topbar { display: flex; }
  .sidebar-overlay { display: block; opacity: 0; pointer-events: none; transition: opacity .3s; }
  .sidebar-overlay.visible { opacity: 1; pointer-events: all; }

  .sidebar {
    position: fixed; top: 0; left: 0; bottom: 0;
    width: min(85vw, 320px);
    transform: translateX(-100%);
    z-index: 30;
    padding-top: 0;
    transition: transform .3s cubic-bezier(.4,0,.2,1);
  }
  .sidebar.open { transform: translateX(0); }

  .main-area { padding-top: 58px; }

  .mob-chat-back { display: flex; }

  .chat-header {
    padding: .7rem 1rem;
    gap: .65rem;
  }
  .chat-hd-product-img { width: 40px; height: 40px; font-size: 1rem; }
  .chat-hd-product-name { font-size: .88rem; }
  .chat-hd-product-price { font-size: .76rem; }
  .customer-avatar { width: 34px; height: 34px; font-size: .72rem; }

  .chat-status-bar { padding: .25rem 1rem; font-size: .63rem; }

  .messages-area { padding: 1rem; gap: .55rem; }
  .bubble { max-width: 82%; font-size: .84rem; }

  .reply-area { padding: .65rem .85rem; gap: .55rem; }
  .reply-textarea { font-size: .84rem; padding: .6rem .85rem; }
  .reply-btn { padding: .6rem 1rem; font-size: .82rem; }
  .reply-btn .send-label { display: none; }

  .toast { right: .75rem; bottom: 5rem; left: .75rem; max-width: none; font-size: .8rem; }

  .pc-msg { max-width: 240px; }
  .pc-img-wrap, .pc-msg-ph { height: 130px; }
}

@media (max-width: 380px) {
  .chat-hd-product-name { font-size: .82rem; }
  .bubble { max-width: 88%; font-size: .82rem; padding: .55rem .85rem; }
  .reply-btn { padding: .6rem .8rem; }
}
</style>
</head>
<body>
<div class="app">

  <!-- Mobile Top Bar -->
  <div class="mobile-topbar" id="mobileTopbar">
    <button class="mob-hamburger" id="mobHamburger" aria-label="Open conversations">
      <span></span><span></span><span></span>
    </button>
    <div class="mob-brand">Volt<span>Edge</span> <span style="font-family:'DM Sans',sans-serif;font-size:.65rem;color:var(--text-light);font-weight:600;letter-spacing:.06em;text-transform:uppercase;vertical-align:middle;">Admin</span></div>
    <button class="mob-back-btn" onclick="window.location.href='admin.html'">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
      Dashboard
    </button>
  </div>

  <!-- Sidebar overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="brand">
        <div class="brand-mark">‚ö°</div>
        <div class="brand-text">
          <div class="bname">Volt<span>Edge</span></div>
          <div class="bsub">Admin Chat</div>
        </div>
      </div>
      <button class="back-btn" onclick="window.location.href='admin.html'">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
        Dashboard
      </button>
    </div>

    <div class="sidebar-search">
      <div class="search-wrap">
        <span class="search-ico">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        </span>
        <input type="text" id="searchInput" placeholder="Search by product or customer‚Ä¶">
      </div>
    </div>

    <div class="sidebar-label">Conversations</div>
    <div class="rooms-list" id="roomsList">
      <div class="loader"><div class="spinner"></div> Loading chats‚Ä¶</div>
    </div>
  </div>

  <!-- MAIN AREA -->
  <div class="main-area" id="mainArea">
    <div class="no-room" id="noRoom">
      <div class="nr-icon">üí¨</div>
      <h3>Select a conversation</h3>
      <p>Choose a chat from the left panel to view messages and reply to customers.</p>
    </div>

    <div id="activeChatArea" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
      <div class="chat-header" id="chatHeader">
        <!-- Mobile back button -->
        <button class="mob-chat-back" id="mobChatBack" onclick="showRoomList()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
        </button>
        <div class="chat-hd-product-img" id="chatHdImg">üíª</div>
        <div class="chat-hd-info">
          <div class="chat-hd-product-name" id="chatHdName">Product</div>
          <div class="chat-hd-product-desc" id="chatHdDesc"></div>
          <div class="chat-hd-product-price">
            <span class="price-pill">GHS</span>
            <span id="chatHdPrice"></span>
          </div>
        </div>
        <div class="chat-hd-right">
          <div class="customer-info">
            <span class="customer-info-name" id="customerName">Customer</span>
            <span class="customer-info-label">Active now</span>
          </div>
          <div class="customer-avatar" id="customerInitial">?</div>
        </div>
      </div>

      <div class="chat-status-bar status-connecting" id="chatStatusBar">
        <div class="sdot"></div><span id="chatStatusTxt">Connecting‚Ä¶</span>
      </div>

      <div class="messages-area" id="messagesArea">
        <div class="loader"><div class="spinner"></div> Loading messages‚Ä¶</div>
      </div>

      <div class="reply-area">
        <textarea class="reply-textarea" id="replyInput" rows="1" placeholder="Type your reply‚Ä¶"></textarea>
        <button class="reply-btn" id="replyBtn" disabled>
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          <span class="send-label">Send</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API_BASE = 'http://localhost:8080/api/v1';
const WS_URL   = 'http://localhost:8080/ws/chat';

const Admin = {
  token:     () => localStorage.getItem('adminToken') || localStorage.getItem('token'),
  adminId:   () => localStorage.getItem('adminId')    || localStorage.getItem('userId'),
  name:      () => localStorage.getItem('adminName')  || localStorage.getItem('userName') || 'Admin',
  isLoggedIn:() => !!(localStorage.getItem('adminToken') || localStorage.getItem('token')),
  headers:   () => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${Admin.token()}` }),
  logout:    () => {
    ['adminToken','adminId','adminName','token','userId','role','userName'].forEach(k => localStorage.removeItem(k));
    window.location.href = 'login.html';
  }
};

if (!Admin.isLoggedIn()) window.location.href = 'login.html';

let rooms = [], activeRoom = null, activeMessages = [];
let stompClient = null, wsConnected = false, pollInterval = null, activeSub = null;

/* ‚îÄ‚îÄ Mobile sidebar helpers ‚îÄ‚îÄ */
function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('visible');
  document.body.style.overflow = 'hidden';
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('visible');
  document.body.style.overflow = '';
}
function showRoomList() {
  // On mobile, hide chat area and show the sidebar
  openSidebar();
}

document.getElementById('mobHamburger').addEventListener('click', openSidebar);
document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

let toastTimer;
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.innerHTML = msg; t.className = 'toast show' + (type ? ' ' + type : '');
  clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 3200);
}

function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmtT(iso) { try { return new Date(iso).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); } catch { return ''; } }
function fmtDate(iso) { try { return new Date(iso).toLocaleDateString([], {month:'short',day:'numeric'}); } catch { return ''; } }
function initials(name) { return String(name||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase(); }

async function apiFetch(url, opts = {}) {
  const res = await fetch(url, {...opts, headers: Admin.headers()});
  if (res.status === 401) { Admin.logout(); throw new Error('Session expired.'); }
  return res;
}

async function loadRooms() {
  try {
    const res = await apiFetch(`${API_BASE}/admin/chat/rooms`);
    if (!res.ok) throw new Error('Failed to load chats');
    rooms = await res.json();
    renderRoomsList(rooms);
  } catch(err) {
    document.getElementById('roomsList').innerHTML =
      `<div class="empty-rooms"><div class="er-icon">‚ö†Ô∏è</div><p>${esc(err.message)}</p></div>`;
  }
}

function renderRoomsList(list) {
  const el = document.getElementById('roomsList');
  if (!list.length) {
    el.innerHTML = '<div class="empty-rooms"><div class="er-icon">üí¨</div><p>No conversations yet.<br>Customers will appear here when they chat.</p></div>';
    return;
  }
  el.innerHTML = list.map(room => {
    const img = room.productImage || '';
    const isActive = activeRoom && activeRoom.chatRoomId === room.chatRoomId;
    return `<div class="room-item ${isActive?'active':''}" onclick="selectRoom(${room.chatRoomId})" data-room-id="${room.chatRoomId}">
      <div class="room-avatar">${img ? `<img src="${esc(img)}" alt="">` : 'üíª'}</div>
      <div class="room-info">
        <div class="room-product-name">${esc(room.productName||'Product')}</div>
        <div class="room-customer">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          ${esc(room.customerName||'Customer')}
        </div>
      </div>
      <div class="room-time">${room.createdAt ? fmtDate(room.createdAt) : ''}</div>
    </div>`;
  }).join('');
}

async function selectRoom(chatRoomId) {
  const room = rooms.find(r => r.chatRoomId === chatRoomId);
  if (!room) return;
  activeRoom = room; activeMessages = [];

  // On mobile, close sidebar after selecting
  closeSidebar();

  document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`[data-room-id="${chatRoomId}"]`)?.classList.add('active');

  document.getElementById('noRoom').style.display = 'none';
  const area = document.getElementById('activeChatArea');
  area.style.display = 'flex'; area.style.flexDirection = 'column';
  area.style.overflow = 'hidden'; area.style.flex = '1';

  const hdImg = document.getElementById('chatHdImg');
  hdImg.innerHTML = room.productImage ? `<img src="${esc(room.productImage)}" alt="">` : 'üíª';
  document.getElementById('chatHdName').textContent = room.productName || 'Product';
  document.getElementById('chatHdPrice').textContent = room.productPrice ? String(room.productPrice).replace(/[^0-9.]/g,'') : '';
  document.getElementById('chatHdDesc').textContent = room.adminName ? `Sold by ${room.adminName}` : '';
  document.getElementById('customerName').textContent = room.customerName || 'Customer';
  document.getElementById('customerInitial').textContent = initials(room.customerName || 'C');

  setStatus('connecting', 'Connecting‚Ä¶');
  document.getElementById('replyBtn').disabled = true;
  await loadMessages(chatRoomId);
  connectWS(chatRoomId);
  document.getElementById('replyBtn').disabled = false;
}

async function loadMessages(chatRoomId) {
  document.getElementById('messagesArea').innerHTML = '<div class="loader"><div class="spinner"></div> Loading‚Ä¶</div>';
  try {
    const res = await apiFetch(`${API_BASE}/chat/rooms/${chatRoomId}/history`);
    if (res.ok) activeMessages = await res.json();
  } catch {}
  renderMessages();
}

function renderMessages() {
  const el = document.getElementById('messagesArea');
  if (!el) return;
  if (!activeMessages.length) {
    el.innerHTML = '<div class="empty-msgs">No messages yet in this conversation.</div>';
    return;
  }
  el.innerHTML = activeMessages.map(m => {
    const isAdmin = m.senderType === 'ADMIN';
    const t = fmtT(m.sentAt);

    if (m.content && m.content.startsWith('PRODUCT_CARD::')) {
      const [, pn, pp, pd, pi] = m.content.split('::');
      return `<div class="pc-msg">
        <div class="pc-img-wrap">
          ${pi ? `<img src="${esc(pi)}" alt="${esc(pn||'')}">` : '<div class="pc-msg-ph">üì¶</div>'}
          <div class="pc-badge">Product</div>
        </div>
        <div class="pc-msg-body">
          <div class="pc-msg-name">${esc(pn||'Product')}</div>
          <div class="pc-msg-price">
            <span class="pc-price-value">GHS ${esc((pp||'0.00').replace(/[^0-9.]/g,''))}</span>
            <span class="pc-price-currency">¬∑ price</span>
          </div>
          ${pd ? `<div class="pc-msg-desc">${esc(pd)}</div>` : ''}
          <div class="pc-divider"></div>
          <div class="pc-msg-footer">
            <span class="pc-msg-time">Sent ¬∑ ${t}</span>
            <button class="pc-view-btn">View details ‚Üí</button>
          </div>
        </div>
      </div>`;
    }

    return `<div class="cmsg ${isAdmin ? 'admin' : 'user'}">
      ${!isAdmin ? `<div class="msg-sender-label">${esc(m.senderName||'Customer')}</div>` : ''}
      <div class="bubble">${esc(m.content||'')}</div>
      <div class="msg-meta">${isAdmin ? 'You' : 'Customer'} ¬∑ ${t}</div>
    </div>`;
  }).join('');
  el.scrollTop = el.scrollHeight;
}

document.getElementById('replyBtn').addEventListener('click', sendReply);
document.getElementById('replyInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendReply(); }
});
document.getElementById('replyInput').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 100) + 'px';
});

async function sendReply() {
  if (!activeRoom) return;
  const input = document.getElementById('replyInput');
  const content = input.value.trim(); if (!content) return;
  const btn = document.getElementById('replyBtn');
  btn.disabled = true; input.value = ''; input.style.height = 'auto';

  const opt = { messageId: 'tmp-' + Date.now(), senderType: 'ADMIN', senderName: Admin.name(), content, isProductCard: false, sentAt: new Date().toISOString() };
  activeMessages.push(opt); renderMessages();

  let sent = false;
  if (wsConnected && stompClient) {
    try {
      stompClient.send(`/app/chat/${activeRoom.chatRoomId}/admin/send`, {}, JSON.stringify({ senderId: Admin.adminId(), content }));
      sent = true;
    } catch {}
  }
  if (!sent) {
    try {
      const res = await apiFetch(`${API_BASE}/admin/chat/rooms/${activeRoom.chatRoomId}/reply`, { method: 'POST', body: JSON.stringify({ content }) });
      if (res.ok) {
        const saved = await res.json();
        activeMessages = activeMessages.filter(m => m.messageId !== opt.messageId);
        activeMessages.push(saved); renderMessages();
      }
    } catch { showToast('Failed to send reply', 'error'); }
  }
  btn.disabled = false; input.focus();
}

function connectWS(chatRoomId) {
  if (stompClient && wsConnected) { subscribeAdminRoom(chatRoomId); return; }
  disconnectWS();
  try {
    const sock = new SockJS(WS_URL);
    stompClient = Stomp.over(sock); stompClient.debug = null;
    stompClient.connect({ 'Authorization': `Bearer ${Admin.token()}` }, () => {
      wsConnected = true; setStatus('connected', 'Live ¬∑ replies appear instantly'); stopPolling();
      subscribeAdminRoom(chatRoomId);
    }, () => { wsConnected = false; stompClient = null; startPolling(chatRoomId); });
    sock.onclose = () => {
      if (wsConnected) {
        wsConnected = false; stompClient = null; setStatus('connecting', 'Reconnecting‚Ä¶');
        setTimeout(() => { if (activeRoom && activeRoom.chatRoomId === chatRoomId) connectWS(chatRoomId); }, 3000);
      }
    };
  } catch { startPolling(chatRoomId); }
}

function subscribeAdminRoom(chatRoomId) {
  if (activeSub) try { activeSub.unsubscribe(); } catch {}
  activeSub = stompClient.subscribe(`/topic/admin/chat/${chatRoomId}`, frame => {
    try {
      const msg = JSON.parse(frame.body);
      if (!activeMessages.some(m => m.messageId === msg.messageId)) {
        activeMessages.push(msg); renderMessages();
        showToast(`üí¨ New message from ${msg.senderName||'customer'}`, 'success');
      }
    } catch {}
  });
}

function startPolling(chatRoomId) {
  if (pollInterval) return;
  setStatus('polling', 'Auto-refresh every 4s');
  pollInterval = setInterval(async () => {
    if (!activeRoom || activeRoom.chatRoomId !== chatRoomId) return;
    try {
      const r = await apiFetch(`${API_BASE}/chat/rooms/${chatRoomId}/history`);
      if (!r.ok) return;
      const h = await r.json();
      if (h.length > activeMessages.length) { activeMessages = h; renderMessages(); }
    } catch {}
  }, 4000);
}

function stopPolling() { if (pollInterval) { clearInterval(pollInterval); pollInterval = null; } }
function disconnectWS() { if (stompClient && wsConnected) { try { stompClient.disconnect(); } catch {} } stompClient = null; wsConnected = false; }
function setStatus(cls, txt) {
  document.getElementById('chatStatusBar').className = `chat-status-bar status-${cls}`;
  document.getElementById('chatStatusTxt').textContent = txt;
}

document.getElementById('searchInput').addEventListener('input', function() {
  const q = this.value.toLowerCase();
  renderRoomsList(rooms.filter(r =>
    (r.productName||'').toLowerCase().includes(q) || (r.customerName||'').toLowerCase().includes(q)
  ));
});

loadRooms();
setInterval(loadRooms, 30000);
window.addEventListener('beforeunload', () => { stopPolling(); disconnectWS(); });
</script>
</body>
</html>